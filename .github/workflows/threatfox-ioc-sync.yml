name: ThreatFox IOC Sync

on:
  schedule:
    # 24 saatte bir Ã§alÄ±ÅŸacak (UTC zamanÄ±)
    - cron: '0 0 * * *'
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in
    inputs:
      days:
        description: 'Number of days to fetch IOCs for'
        required: false
        default: '1'
        type: choice
        options:
        - '1'
        - '2'
        - '3'

env:
  PYTHON_VERSION: '3.9'

jobs:
  sync-iocs:
    name: Sync IOCs from ThreatFox
    runs-on: ubuntu-latest
    permissions:
      contents: write  
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        pip install -r scripts/requirements.txt
        
    - name: Run ThreatFox IOC Sync
      id: sync
      env:
        THREATFOX_API_KEY: ${{ secrets.THREATFOX_API_KEY }}
      run: |
        python scripts/threatfox_converter.py
        
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions"
        git add iocs/
        
        # DeÄŸiÅŸiklik olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        if git diff-index --quiet HEAD --; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ¤– Auto-update ThreatFox IOCs [$(date +%Y-%m-%d)] - ${{ steps.sync.outputs.total_iocs }} IOCs"
          git push
        fi
        
    - name: Create summary
      run: |
        echo "## ThreatFox IOC Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Successfully synced ${{ steps.sync.outputs.total_iocs }} IOCs**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Output file:** ${{ steps.sync.outputs.output_file }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ•’ **Last run:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the generated XML file from the \`iocs/\` directory" >> $GITHUB_STEP_SUMMARY
        echo "2. Import the XML into your Kaspersky product" >> $GITHUB_STEP_SUMMARY
        echo "3. The workflow will run again in 24 hours automatically" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload IOC artifacts
      uses: actions/upload-artifact@v4
      with:
        name: threatfox-iocs
        path: iocs/
        retention-days: 7
